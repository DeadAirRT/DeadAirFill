<?xml version="1.0" encoding="utf-8"?>
<mdscript name="DeadAirTradeStationFix" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
	<cues>
		<cue name="Init" version="2">
			<actions>
				<set_value name="$TradeStationDebugChance" exact="false" />
			</actions>
			<patch sinceversion="2">
				<reset_cue cue="this"/>
			</patch>
			<cues>
				<cue name="FindTradeStations" instantiate="false">
					<conditions>
						<check_any>
							<event_cue_signalled cue="md.Setup.GameStart"/>
							<event_game_loaded/>
						</check_any>
					</conditions>
					<delay exact="60s" />
					<actions>
						<set_value name="$delayalpha" exact="0s" />
						<set_value name="$delaybravo" exact="0s" />
						<find_station groupname="$TradeStations" append="true" multiple="true" space="player.galaxy" functional="true" tradestation="true" shipyard="false" wharf="false" canequipships="false">
							<match owner="faction.player" negate="true" />
							<match_content class="class.buildmodule" negate="true"/>
						</find_station>
						<find_station groupname="$TradeStations" append="true" multiple="true" space="player.galaxy" functional="true">
							<match_any>
								<match macro="macro.station_arg_tradestation_base_01_macro"/>
								<match macro="macro.station_par_tradestation_base_01_macro"/>
								<match macro="macro.station_tel_tradestation_base_01_macro"/>
								<match macro="macro.station_spl_tradestation_base_01_macro"/>
								<match macro="macro.station_arg_tradestation_dabase_01_macro"/>
								<match macro="macro.station_par_tradestation_dabase_01_macro"/>
								<match macro="macro.station_tel_tradestation_dabase_01_macro"/>
								<match macro="macro.station_spl_tradestation_dabase_01_macro"/>
								<match macro="macro.landmarks_tel_tradestation_01_macro"/>
								<match macro="macro.landmarks_par_tradestation_01_macro"/>
							</match_any>
							<match_content class="class.buildmodule" negate="true"/>
						</find_station>
						<do_all exact="$TradeStations.count" counter="$a">
							<set_value name="$TradeStation" exact="$TradeStations.{$a}" />
							<debug_to_file name="'TradestationFix'" directory="'DeadAir_Fill'" text="'%1, %2, %3, %4, istradestation %5, iswharf %6, isshipyard %7, isequipmentdock %8'.[$TradeStation.trueowner, $TradeStation.sector.knownname, $TradeStation.knownname, $TradeStation.macro, $TradeStation.istradestation, $TradeStation.iswharf, $TradeStation.isshipyard, $TradeStation.isequipmentdock]" output="false" append="true" chance="if @$TradeStationDebugChance then ($TradeStationDebugChance * 100) else 0"/>
							<set_value name="$delayalpha" exact="($delayalpha + 0.5)s" />
							<include_actions ref="FixTradeStations" />
						</do_all>
						<remove_value name="$TradeStations" />
						<remove_value name="$TradeStation" />
						<set_value name="$delayalpha" exact="0" />
						<find_station groupname="$ShipyardWharfs" append="true" multiple="true" space="player.galaxy" functional="true" shipyard="true">
							<match owner="faction.player" negate="true" />
						</find_station>
						<find_station groupname="$ShipyardWharfs" append="true" multiple="true" space="player.galaxy" functional="true" wharf="true">
							<match owner="faction.player" negate="true" />
						</find_station>
						<find_station groupname="$ShipyardWharfs" append="true" multiple="true" space="player.galaxy" functional="true" canequipships="true">
							<match_content class="class.buildmodule" />
							<match owner="faction.player" negate="true" />
						</find_station>
						<do_all exact="$ShipyardWharfs.count" counter="$a">
							<set_value name="$ShipyardWharf" exact="$ShipyardWharfs.{$a}" />
							<debug_to_file name="'TradestationFix'" directory="'DeadAir_Fill'" text="'%1, %2, %3'.[$ShipyardWharf.trueowner, $ShipyardWharf.sector.knownname, $ShipyardWharf.knownname]" output="false" append="true" chance="if @$TradeStationDebugChance then ($TradeStationDebugChance * 100) else 0"/>
							<debug_to_file name="'TradestationFix'" directory="'DeadAir_Fill'" text="'%1, %2, %3, %4, istradestation %5, iswharf %6, isshipyard %7, isequipmentdock %8'.[$ShipyardWharf.trueowner, $ShipyardWharf.sector.knownname, $ShipyardWharf.knownname, $ShipyardWharf.macro, $ShipyardWharf.istradestation, $ShipyardWharf.iswharf, $ShipyardWharf.isshipyard, $ShipyardWharf.isequipmentdock]" output="false" append="true" chance="if @$TradeStationDebugChance then ($TradeStationDebugChance * 100) else 0"/>
							<set_value name="$delaybravo" exact="($delaybravo + 0.5)s" />
							<include_actions ref="FixShipyardWharfs" />
						</do_all>
						<remove_value name="$ShipyardWharfs" />
						<remove_value name="$ShipyardWharf" />
						<set_value name="$delaybravo" exact="0" />
					</actions>
				</cue>
				<library name="FixTradeStations">
					<delay exact="$delayalpha" />
					<actions>
						<do_if value="$TradeStation.isoperational">
							<debug_to_file name="'TradestationFix'" directory="'DeadAir_Fill'" text="'%1, %2, %3 is operational. %4'.[$TradeStation.trueowner, $TradeStation.sector.knownname, $TradeStation.knownname, $delayalpha]" output="false" append="true" chance="if @$TradeStationDebugChance then ($TradeStationDebugChance * 100) else 0"/>
							<do_if value="($TradeStation.tradewares.list.count lt 5)">
								<debug_to_file name="'TradestationFix'" directory="'DeadAir_Fill'" text="'%1, %2, %3, has less than 5 tradewares'.[$TradeStation.trueowner, $TradeStation.sector.knownname, $TradeStation.knownname]" output="false" append="true" chance="if @$TradeStationDebugChance then ($TradeStationDebugChance * 100) else 0"/>
								<do_all exact="$TradeStation.tradewares.list.count" counter="$b" reverse="true">
									<remove_tradeware object="$TradeStation" ware="$TradeStation.tradewares.list.{$b}" />
								</do_all>
								<add_tradeware object="$TradeStation" ware="ware.medicalsupplies" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.water" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.advancedcomposites" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.advancedelectronics" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.antimatterconverters" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.claytronics" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.dronecomponents" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.energycells" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.engineparts" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.fieldcoils" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.hullparts" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.missilecomponents" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.scanningarrays" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.shieldcomponents" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.smartchips" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.turretcomponents" allowbuy="true" allowsell="true" lockavgprice="true" />
								<add_tradeware object="$TradeStation" ware="ware.weaponcomponents" allowbuy="true" allowsell="true" lockavgprice="true" />
								
								<do_if value="($TradeStation.trueowner == faction.teladi) or ($TradeStation.trueowner == faction.ministry) or ($TradeStation.trueowner == faction.scaleplate)">
									<add_tradeware object="$TradeStation" ware="ware.nostropoil" allowbuy="true" allowsell="true" lockavgprice="true" />
									<add_tradeware object="$TradeStation" ware="ware.majadust" allowbuy="true" allowsell="true" lockavgprice="true" />
									<add_tradeware object="$TradeStation" ware="ware.spacefuel" allowbuy="true" allowsell="true" lockavgprice="true" />
									<add_tradeware object="$TradeStation" ware="ware.nividium" allowbuy="true" allowsell="false" lockavgprice="false" />
								</do_if>
								<do_elseif value="($TradeStation.trueowner == faction.argon) or ($TradeStation.trueowner == faction.antigone) or ($TradeStation.trueowner == faction.hatikvah)">
									<add_tradeware object="$TradeStation" ware="ware.foodrations" allowbuy="true" allowsell="true" lockavgprice="true" />
									<add_tradeware object="$TradeStation" ware="ware.spaceweed" allowbuy="true" allowsell="true" lockavgprice="true" />
									<add_tradeware object="$TradeStation" ware="ware.majadust" allowbuy="true" allowsell="true" lockavgprice="true" />
									<add_tradeware object="$TradeStation" ware="ware.nividium" allowbuy="true" allowsell="false" lockavgprice="false" />
								</do_elseif>
								<do_elseif value="($TradeStation.trueowner == faction.holyorder) or ($TradeStation.trueowner == faction.paranid) or ($TradeStation.trueowner == faction.alliance) or ($TradeStation.trueowner == faction.buccaneers)">
									<add_tradeware object="$TradeStation" ware="ware.sojahusk" allowbuy="true" allowsell="true" lockavgprice="true" />
									<add_tradeware object="$TradeStation" ware="ware.spaceweed" allowbuy="true" allowsell="true" lockavgprice="true" />
									<add_tradeware object="$TradeStation" ware="ware.spacefuel" allowbuy="true" allowsell="true" lockavgprice="true" />
								</do_elseif>
								<do_elseif value="($TradeStation.trueowner == faction.court) or ($TradeStation.trueowner == faction.fallensplit) or ($TradeStation.trueowner == faction.freesplit) or ($TradeStation.trueowner == faction.split)">
									<add_tradeware object="$TradeStation" ware="ware.cheltmeat" allowbuy="true" allowsell="true" lockavgprice="true" />
									<add_tradeware object="$TradeStation" ware="ware.scruffinfruits" allowbuy="true" allowsell="true" lockavgprice="true" />
									<add_tradeware object="$TradeStation" ware="ware.nividium" allowbuy="true" allowsell="false" lockavgprice="false" />
								</do_elseif>
								
								<add_default_production_wares object="$TradeStation" lowerlimit="25" upperlimit="50" />
							</do_if>
							<debug_to_file name="'TradestationFix'" directory="'DeadAir_Fill'" text="'%1, %2, %3, %4 tradewares'.[$TradeStation.trueowner, $TradeStation.sector.knownname, $TradeStation.knownname, $TradeStation.tradewares.list.count]" output="false" append="true" chance="if @$TradeStationDebugChance then ($TradeStationDebugChance * 100) else 0"/>
						</do_if>
					</actions>
				</library>
				<library name="FixShipyardWharfs">
					<delay exact="$delaybravo" />
					<actions>
						<do_if value="$ShipyardWharf.isoperational">
							<debug_to_file name="'TradestationFix'" directory="'DeadAir_Fill'" text="'%1, %2, %3 is operational. %4'.[$ShipyardWharf.trueowner, $ShipyardWharf.sector.knownname, $ShipyardWharf.knownname, $delaybravo]" output="false" append="true" chance="if @$TradeStationDebugChance then ($TradeStationDebugChance * 100) else 0"/>
							<do_if value="($ShipyardWharf.tradewares.list.count gt 0)">
								<debug_to_file name="'TradestationFix'" directory="'DeadAir_Fill'" text="'%1, %2, %3, has tradewares'.[$ShipyardWharf.trueowner, $ShipyardWharf.sector.knownname, $ShipyardWharf.knownname]" output="false" append="true" chance="if @$TradeStationDebugChance then ($TradeStationDebugChance * 100) else 0"/>
								<do_all exact="$ShipyardWharf.tradewares.list.count" counter="$c" reverse="true">
									<remove_tradeware object="$ShipyardWharf" ware="$ShipyardWharf.tradewares.list.{$c}" />
								</do_all>
							</do_if>
							<debug_to_file name="'TradestationFix'" directory="'DeadAir_Fill'" text="'%1, %2, %3, %4 tradewares'.[$ShipyardWharf.trueowner, $ShipyardWharf.sector.knownname, $ShipyardWharf.knownname, $ShipyardWharf.tradewares.list.count]" output="false" append="true" chance="if @$TradeStationDebugChance then ($TradeStationDebugChance * 100) else 0"/>
						</do_if>
					</actions>
				</library>
			</cues>
		</cue>
	</cues>
</mdscript>
